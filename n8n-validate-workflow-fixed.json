{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "validate",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -208,
        -16
      ],
      "id": "cb646a11-ab98-4edc-9a27-414de8e0302f",
      "name": "Webhook",
      "webhookId": "0d2ca70f-67bd-48a5-be76-78a623a99ba5"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        688,
        16
      ],
      "id": "d3848d70-8f1b-43a4-ab43-d48890f6789b",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# n8n AI Agent Prompt for User Validation\n\n## System Prompt for AI Agent\n\n```\nYou are a user authentication agent. Your task is to validate user credentials and return user information in a specific JSON format.\n\n## Your Task:\n1. Receive username and passcode from the webhook request\n2. Search the Airtable User Accounts table for a matching user\n3. Validate the passcode matches the Password field\n4. Return user information in the exact JSON format specified below\n\n## Input:\nYou will receive:\n- username: string (from webhook body)\n- passcode: string (from webhook body)\n- Airtable user records (from Airtable tool)\n\n## Validation Rules:\n1. Search User Accounts table for a record where Username field matches the input username (case-insensitive)\n2. If no user is found, return: {\"status\": \"error\", \"message\": \"User not found\"}\n3. If user is found but Account Status is not \"Active\", return: {\"status\": \"error\", \"message\": \"Account is not active\"}\n4. If passcode does not match Password field, return: {\"status\": \"error\", \"message\": \"Invalid passcode\"}\n5. If validation succeeds, return the user data in the format below\n\n## Output Format (ONLY if validation succeeds):\n{\n  \"status\": \"success\",\n  \"username\": \"<username from Username field>\",\n  \"role\": \"<role from Role field>\",\n  \"associated_profile\": \"<value from Associated Profile field>\",\n  \"kam_id\": \"<value from KAM ID field or null>\",\n  \"client_id\": \"<value from Client ID field or null>\",\n  \"nbfc_id\": \"<value from NBFC ID field or null>\",\n  \"credit_team_id\": \"<value from Credit Team ID field or null>\"\n}\n\n## CRITICAL RULES:\n- NEVER return test user data (test@example.com, test-user-123, Test User)\n- NEVER return hardcoded or default user data\n- If user is not found, return error status\n- Only return success if username AND passcode match exactly\n- Account Status must be \"Active\" for successful validation\n```",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        0,
        -16
      ],
      "id": "002a370e-1647-4ee2-937e-1cce2bd5c47f",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        16,
        240
      ],
      "id": "8dd840cf-b133-41df-b499-8be1020f62ec",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "JWuuxy0L5XtsVuUU",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appzbyi8q7pJRl1cd",
          "mode": "list",
          "cachedResultName": "Seven Dashboard",
          "cachedResultUrl": "https://airtable.com/appzbyi8q7pJRl1cd"
        },
        "table": {
          "__rl": true,
          "value": "tbl7RRcehD5xLiPv7",
          "mode": "list",
          "cachedResultName": "User Accounts",
          "cachedResultUrl": "https://airtable.com/appzbyi8q7pJRl1cd/tbl7RRcehD5xLiPv7"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtableTool",
      "typeVersion": 2.1,
      "position": [
        160,
        192
      ],
      "id": "83255aa0-6934-493b-a331-5ef295fd4b14",
      "name": "Search records in Airtable",
      "rewireOutputLogTo": "ai_tool",
      "credentials": {
        "airtableTokenApi": {
          "id": "7GvicfJT1nu7OUoa",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"status\": \"success\",\n  \"username\": \"kam@test.com\",\n  \"role\": \"KAM\",\n  \"associated_profile\": \"Key Account Manager â€“ North Zone\",\n  \"kam_id\": \"KAM_1021\",\n  \"client_id\": null,\n  \"nbfc_id\": null,\n  \"credit_team_id\": null\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        272,
        288
      ],
      "id": "ad7de391-21a6-48de-b888-5ee86437e9fe",
      "name": "Structured Output Parser"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Search records in Airtable": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "ai_outputParser",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "cede7282cee9e04cab35956e332b88bc74affd8110baf9d026857557d15dcea0"
  }
}
